<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Noisy Neighbor â€” Quota Monitor</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Syne:wght@400;600;700;800&display=swap');

  :root {
    --bg:       #060d1a;
    --surface:  #0d1d35;
    --surface2: #112240;
    --border:   #1e3a5f;
    --text:     #e2e8f0;
    --muted:    #64748b;
    --free:     #94a3b8;
    --pro:      #3b82f6;
    --ent:      #8b5cf6;
    --allow:    #10b981;
    --throttle: #ef4444;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Syne', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Animated grid background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(59, 130, 246, 0.04) 1px, transparent 1px),
      linear-gradient(90deg, rgba(59, 130, 246, 0.04) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .container { max-width: 1200px; margin: 0 auto; padding: 0 24px; position: relative; z-index: 1; }

  /* Header */
  header {
    padding: 28px 0 20px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 32px;
  }
  .header-inner { display: flex; align-items: center; justify-content: space-between; }
  .logo {
    display: flex; align-items: center; gap: 12px;
  }
  .logo-icon {
    width: 40px; height: 40px; border-radius: 10px;
    background: linear-gradient(135deg, #1d4ed8, #7c3aed);
    display: flex; align-items: center; justify-content: center;
    font-size: 20px; box-shadow: 0 0 24px rgba(59,130,246,0.3);
  }
  h1 { font-size: 22px; font-weight: 800; letter-spacing: -0.5px; }
  h1 span { color: var(--pro); }
  .subtitle { font-size: 12px; color: var(--muted); font-family: 'JetBrains Mono', monospace; margin-top: 2px; }

  .status-badge {
    display: flex; align-items: center; gap: 8px;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 20px; padding: 6px 14px;
    font-size: 12px; font-family: 'JetBrains Mono', monospace;
  }
  .dot {
    width: 8px; height: 8px; border-radius: 50%; background: var(--muted);
    transition: background 0.3s;
  }
  .dot.live { background: var(--allow); box-shadow: 0 0 8px var(--allow); animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }

  /* Summary stats */
  .summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 32px; }
  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    position: relative;
    overflow: hidden;
  }
  .stat-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; height: 2px;
    background: linear-gradient(90deg, var(--accent, var(--pro)), transparent);
  }
  .stat-label { font-size: 11px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; }
  .stat-value { font-size: 32px; font-weight: 800; font-family: 'JetBrains Mono', monospace; line-height: 1; }
  .stat-sub { font-size: 11px; color: var(--muted); margin-top: 6px; font-family: 'JetBrains Mono', monospace; }

  /* Tenant cards */
  .tenants { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 32px; }

  .tenant-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
    transition: box-shadow 0.3s;
  }
  .tenant-card:hover { box-shadow: 0 0 30px rgba(59,130,246,0.15); }

  .card-header {
    padding: 18px 20px 14px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
  }
  .tier-badge {
    display: inline-flex; align-items: center; gap: 6px;
    font-size: 11px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase;
    padding: 4px 10px; border-radius: 6px;
  }
  .tier-dot { width: 6px; height: 6px; border-radius: 50%; }
  .rps-badge {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: var(--muted);
    background: var(--surface2);
    padding: 3px 8px; border-radius: 4px;
  }

  .card-body { padding: 20px; }

  /* Quota bar */
  .quota-section { margin-bottom: 20px; }
  .quota-labels { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px; }
  .quota-label { font-size: 11px; color: var(--muted); font-family: 'JetBrains Mono', monospace; }
  .quota-val { font-size: 13px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }

  .quota-track {
    height: 8px; background: var(--surface2);
    border-radius: 4px; overflow: hidden; position: relative;
  }
  .quota-fill {
    height: 100%; border-radius: 4px;
    transition: width 0.5s cubic-bezier(0.4,0,0.2,1);
  }

  /* Metrics grid */
  .metrics-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
  .metric-box {
    background: var(--surface2); border-radius: 10px; padding: 14px 12px;
    text-align: center;
  }
  .metric-val {
    font-size: 24px; font-weight: 800;
    font-family: 'JetBrains Mono', monospace;
    line-height: 1;
    margin-bottom: 4px;
  }
  .metric-lbl { font-size: 9px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; }

  /* Throttle meter */
  .throttle-bar {
    margin-top: 16px;
  }
  .throttle-labels { display: flex; justify-content: space-between; font-size: 10px; color: var(--muted); margin-bottom: 5px; font-family: 'JetBrains Mono', monospace; }
  .throttle-track { height: 5px; background: var(--surface2); border-radius: 3px; overflow: hidden; }
  .throttle-fill { height: 100%; border-radius: 3px; transition: width 0.5s cubic-bezier(0.4,0,0.2,1); background: var(--throttle); }

  /* Bottom panel */
  .bottom-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }

  .panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px; overflow: hidden;
  }
  .panel-header {
    padding: 14px 20px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
  }
  .panel-title { font-size: 13px; font-weight: 700; letter-spacing: 0.5px; }
  .panel-body { padding: 16px; }

  /* Event log */
  .event-log { font-family: 'JetBrains Mono', monospace; font-size: 11px; }
  .event-row {
    display: grid;
    grid-template-columns: 80px 110px 90px 1fr;
    gap: 10px;
    padding: 6px 0;
    border-bottom: 1px solid rgba(255,255,255,0.04);
    align-items: center;
    animation: fadeIn 0.3s ease;
  }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }
  .event-row:last-child { border-bottom: none; }
  .ev-time { color: var(--muted); }
  .ev-tenant { font-weight: 600; }
  .ev-status { padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; letter-spacing: 1px; text-align: center; }
  .ev-status.allow    { background: rgba(16,185,129,0.15); color: #10b981; }
  .ev-status.throttle { background: rgba(239,68,68,0.15);  color: #ef4444; }
  .ev-remaining { color: var(--muted); }

  /* Legend */
  .legend-grid { display: flex; flex-direction: column; gap: 12px; }
  .legend-item { display: flex; align-items: flex-start; gap: 10px; }
  .legend-swatch { width: 12px; height: 12px; border-radius: 3px; flex-shrink: 0; margin-top: 2px; }
  .legend-text { font-size: 11px; color: var(--text); line-height: 1.5; }
  .legend-text strong { display: block; font-size: 12px; margin-bottom: 1px; }

  footer { padding: 28px 0; text-align: center; color: var(--muted); font-size: 11px; font-family: 'JetBrains Mono', monospace; border-top: 1px solid var(--border); margin-top: 32px; }
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="header-inner">
      <div class="logo">
        <div class="logo-icon">âš¡</div>
        <div>
          <h1>Noisy Neighbor <span>Monitor</span></h1>
          <div class="subtitle">Multi-Tenant Quota Enforcement Â· Token Bucket Â· Redis-backed</div>
        </div>
      </div>
      <div class="status-badge">
        <div class="dot" id="wsDot"></div>
        <span id="wsStatus">Connecting...</span>
      </div>
    </div>
  </header>

  <!-- Summary -->
  <div class="summary">
    <div class="stat-card" style="--accent: var(--allow)">
      <div class="stat-label">Total Allowed</div>
      <div class="stat-value" id="totalAllowed" style="color: var(--allow)">â€”</div>
      <div class="stat-sub" id="totalAllowedSub">across all tenants</div>
    </div>
    <div class="stat-card" style="--accent: var(--throttle)">
      <div class="stat-label">Total Throttled</div>
      <div class="stat-value" id="totalThrottled" style="color: var(--throttle)">â€”</div>
      <div class="stat-sub" id="globalThrottleRate">noisy neighbor events</div>
    </div>
    <div class="stat-card" style="--accent: var(--pro)">
      <div class="stat-label">Req / Second (global)</div>
      <div class="stat-value" id="globalRps" style="color: var(--pro)">â€”</div>
      <div class="stat-sub">across all tiers</div>
    </div>
    <div class="stat-card" style="--accent: var(--ent)">
      <div class="stat-label">Active Tenants</div>
      <div class="stat-value" id="activeTenants" style="color: var(--ent)">3</div>
      <div class="stat-sub">Free Â· Pro Â· Enterprise</div>
    </div>
  </div>

  <!-- Tenant Cards -->
  <div class="tenants" id="tenantGrid"></div>

  <!-- Bottom panel -->
  <div class="bottom-grid">
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title">âš¡ Live Event Stream</span>
        <span style="font-size:11px; color: var(--muted); font-family: 'JetBrains Mono', monospace">last 20 events</span>
      </div>
      <div class="panel-body">
        <div style="display:grid; grid-template-columns: 80px 110px 90px 1fr; gap:10px; padding: 0 0 8px; border-bottom: 1px solid var(--border); margin-bottom:8px;">
          <span style="font-size:10px; color:var(--muted); text-transform:uppercase; letter-spacing:1px;">Time</span>
          <span style="font-size:10px; color:var(--muted); text-transform:uppercase; letter-spacing:1px;">Tenant</span>
          <span style="font-size:10px; color:var(--muted); text-transform:uppercase; letter-spacing:1px;">Status</span>
          <span style="font-size:10px; color:var(--muted); text-transform:uppercase; letter-spacing:1px;">Tokens Left</span>
        </div>
        <div class="event-log" id="eventLog">
          <div style="text-align:center; padding: 40px; color: var(--muted); font-family: 'JetBrains Mono', monospace; font-size:12px;">Waiting for events...</div>
        </div>
      </div>
    </div>
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title">ðŸ“‹ How It Works</span>
      </div>
      <div class="panel-body">
        <div class="legend-grid">
          <div class="legend-item">
            <div class="legend-swatch" style="background: var(--free)"></div>
            <div class="legend-text"><strong style="color:var(--free)">Free Tier (10/s)</strong>Lowest quota. Gets throttled aggressively â€” simulates the noisy neighbor being contained.</div>
          </div>
          <div class="legend-item">
            <div class="legend-swatch" style="background: var(--pro)"></div>
            <div class="legend-text"><strong style="color:var(--pro)">Pro Tier (100/s)</strong>Mid tier. Occasional bursts push to limit. Protected from free-tier noise.</div>
          </div>
          <div class="legend-item">
            <div class="legend-swatch" style="background: var(--ent)"></div>
            <div class="legend-text"><strong style="color:var(--ent)">Enterprise (500/s)</strong>Highest quota + burst capacity. Nearly always allowed. Fully isolated.</div>
          </div>
          <div class="legend-item">
            <div class="legend-swatch" style="background: #1e40af"></div>
            <div class="legend-text"><strong style="color:#60a5fa">Token Bucket (Redis Lua)</strong>Atomic read-modify-write prevents over-granting under concurrent load.</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <footer>Article 201 Â· System Design Interview Roadmap Â· Section 8: Production Engineering</footer>
</div>

<script>
const TIER_COLORS = {
  'tenant-free':       { color: '#94a3b8', bg: 'rgba(148,163,184,0.1)', border: 'rgba(148,163,184,0.25)', name: 'FREE' },
  'tenant-pro':        { color: '#3b82f6', bg: 'rgba(59,130,246,0.1)',  border: 'rgba(59,130,246,0.25)',  name: 'PRO' },
  'tenant-enterprise': { color: '#8b5cf6', bg: 'rgba(139,92,246,0.1)', border: 'rgba(139,92,246,0.25)', name: 'ENTERPRISE' }
};

let lastData = null;
let allEvents = [];

// â”€â”€ WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const wsProto = location.protocol === 'https:' ? 'wss' : 'ws';
const ws = new WebSocket(`${wsProto}://${location.host}`);
const dot    = document.getElementById('wsDot');
const status = document.getElementById('wsStatus');

ws.onopen = () => {
  dot.className = 'dot live';
  status.textContent = 'Live';
};
ws.onclose = () => {
  dot.className = 'dot';
  status.textContent = 'Disconnected';
};
ws.onmessage = (e) => {
  const msg = JSON.parse(e.data);
  if (msg.type === 'metrics') renderAll(msg.data);
};

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAll(data) {
  lastData = data;
  renderSummary(data);
  renderTenants(data);
  collectEvents(data);
  renderEventLog();
}

function renderSummary(data) {
  let totalA = 0, totalT = 0, totalRps = 0;
  for (const v of Object.values(data)) {
    totalA   += v.allowed;
    totalT   += v.throttled;
    totalRps += v.currentRps;
  }
  const total = totalA + totalT;
  const gRate = total > 0 ? Math.round((totalT / total) * 100) : 0;

  document.getElementById('totalAllowed').textContent  = fmt(totalA);
  document.getElementById('totalThrottled').textContent = fmt(totalT);
  document.getElementById('globalThrottleRate').textContent = `${gRate}% throttle rate`;
  document.getElementById('globalRps').textContent = totalRps;
}

function renderTenants(data) {
  const grid = document.getElementById('tenantGrid');
  grid.innerHTML = '';
  for (const [id, v] of Object.entries(data)) {
    const tc   = TIER_COLORS[id];
    const total = v.allowed + v.throttled;
    const pct   = v.burst > 0 ? Math.min(100, Math.round(((v.burst - Math.max(0, v.burst - v.throttled % v.burst)) / v.burst) * 100)) : 0;
    const throttlePct = v.throttleRate;

    grid.innerHTML += `
      <div class="tenant-card">
        <div class="card-header">
          <div class="tier-badge" style="background:${tc.bg}; border:1px solid ${tc.border}; color:${tc.color}">
            <div class="tier-dot" style="background:${tc.color}"></div>
            ${tc.name}
          </div>
          <div class="rps-badge">${v.currentRps} rps</div>
        </div>
        <div class="card-body">
          <div class="quota-section">
            <div class="quota-labels">
              <span class="quota-label">Throttle Rate</span>
              <span class="quota-val" style="color:${throttlePct > 50 ? '#ef4444' : throttlePct > 10 ? '#f59e0b' : '#10b981'}">${throttlePct}%</span>
            </div>
            <div class="quota-track">
              <div class="quota-fill" style="width:${throttlePct}%; background: ${throttlePct > 50 ? '#ef4444' : throttlePct > 10 ? '#f59e0b' : '#10b981'}"></div>
            </div>
          </div>
          <div class="metrics-grid">
            <div class="metric-box">
              <div class="metric-val" style="color:#10b981">${fmt(v.allowed)}</div>
              <div class="metric-lbl">Allowed</div>
            </div>
            <div class="metric-box">
              <div class="metric-val" style="color:#ef4444">${fmt(v.throttled)}</div>
              <div class="metric-lbl">Throttled</div>
            </div>
            <div class="metric-box">
              <div class="metric-val" style="color:${tc.color}">${v.rate}</div>
              <div class="metric-lbl">Limit/s</div>
            </div>
          </div>
          <div class="throttle-bar">
            <div class="throttle-labels">
              <span>Burst limit</span>
              <span>${v.burst} tokens</span>
            </div>
            <div class="throttle-track">
              <div class="throttle-fill" style="width: ${Math.min(100, (v.currentRps / v.rate) * 100)}%; background: ${tc.color}; opacity: 0.8"></div>
            </div>
          </div>
        </div>
      </div>
    `;
  }
}

function collectEvents(data) {
  for (const [id, v] of Object.entries(data)) {
    const tc = TIER_COLORS[id];
    for (const ev of v.events) {
      if (!allEvents.find(e => e.id === ev.id)) {
        allEvents.unshift({ ...ev, tenant: id, tier: tc.name, color: tc.color });
      }
    }
  }
  allEvents.sort((a, b) => b.ts - a.ts);
  allEvents = allEvents.slice(0, 20);
}

function renderEventLog() {
  const log = document.getElementById('eventLog');
  if (!allEvents.length) return;
  log.innerHTML = allEvents.map(ev => `
    <div class="event-row">
      <span class="ev-time">${new Date(ev.ts).toLocaleTimeString('en',{hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'})}</span>
      <span class="ev-tenant" style="color:${ev.color}">${ev.tier}</span>
      <span class="ev-status ${ev.status === 'ALLOW' ? 'allow' : 'throttle'}">${ev.status}</span>
      <span class="ev-remaining">${ev.remaining} tokens</span>
    </div>
  `).join('');
}

function fmt(n) {
  if (n >= 1_000_000) return (n / 1_000_000).toFixed(1) + 'M';
  if (n >= 1_000)     return (n / 1_000).toFixed(1) + 'k';
  return n;
}

// Fetch initial metrics via HTTP as fallback
fetch('/metrics').then(r => r.json()).then(renderAll).catch(() => {});
</script>
</body>
</html>
