<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connection Exhaustion Demo - SystemDRD</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        }
        
        .card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .metric:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            color: #666;
            font-size: 0.95em;
        }
        
        .metric-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .status-healthy {
            background: #d4edda;
            color: #155724;
        }
        
        .status-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-critical {
            background: #f8d7da;
            color: #721c24;
        }
        
        .chart-container {
            grid-column: 1 / -1;
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            height: 400px;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .timestamp {
            text-align: center;
            color: white;
            margin-top: 20px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ”Œ Connection Exhaustion Demo</h1>
            <p>Real-time monitoring of L4 vs L7 load balancing behavior</p>
        </div>
        
        <div id="alerts"></div>
        
        <div class="grid">
            <div class="card">
                <h3>L4 HAProxy (Direct)</h3>
                <div class="metric">
                    <span class="metric-label">Active Connections</span>
                    <span class="metric-value" id="l4-connections">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Total Requests</span>
                    <span class="metric-value" id="l4-total">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Success Rate</span>
                    <span class="metric-value" id="l4-success-rate">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Avg Response Time</span>
                    <span class="metric-value" id="l4-response-time">-</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="l4-progress" style="width: 0%">0%</div>
                </div>
            </div>
            
            <div class="card">
                <h3>Backend Server</h3>
                <div class="metric">
                    <span class="metric-label">Status</span>
                    <span class="status-badge status-healthy" id="backend-status">Healthy</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Max Connections</span>
                    <span class="metric-value" id="max-connections">100</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Failed Requests</span>
                    <span class="metric-value" id="failed-requests">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Uptime</span>
                    <span class="metric-value" id="uptime">-</span>
                </div>
            </div>
            
            <div class="card">
                <h3>L7 Nginx (Buffered)</h3>
                <div class="metric">
                    <span class="metric-label">Status</span>
                    <span class="status-badge status-healthy">Available</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Connection Mode</span>
                    <span class="metric-value" style="font-size: 1em;">Buffered</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Backend Reuse</span>
                    <span class="metric-value" style="font-size: 1em;">Enabled</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Port</span>
                    <span class="metric-value">9090</span>
                </div>
                <div style="margin-top: 15px; padding: 10px; background: #d4edda; border-radius: 5px; color: #155724; font-size: 0.9em;">
                    âœ“ Switch clients to :9090 to see improvement
                </div>
            </div>
        </div>
        
        <div class="chart-container">
            <canvas id="connectionChart"></canvas>
        </div>
        
        <div class="timestamp" id="timestamp">Last updated: -</div>
    </div>
    
    <script>
        const maxConnections = 100;
        const chartData = {
            labels: [],
            datasets: [{
                label: 'Active Connections',
                data: [],
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }]
        };
        
        const ctx = document.getElementById('connectionChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Connection Count Over Time',
                        font: {
                            size: 18
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: maxConnections + 10,
                        ticks: {
                            font: {
                                size: 12
                            }
                        }
                    },
                    x: {
                        ticks: {
                            font: {
                                size: 12
                            }
                        }
                    }
                },
                annotation: {
                    annotations: [{
                        type: 'line',
                        mode: 'horizontal',
                        scaleID: 'y',
                        value: maxConnections,
                        borderColor: '#dc2626',
                        borderWidth: 2,
                        label: {
                            enabled: true,
                            content: 'Connection Limit'
                        }
                    }]
                }
            }
        });
        
        async function fetchStats() {
            try {
                const response = await fetch('http://localhost:8080/api/stats');
                const data = await response.json();
                
                document.getElementById('l4-connections').textContent = data.active_connections;
                document.getElementById('l4-total').textContent = data.total_requests;
                
                const successRate = ((data.success_requests / Math.max(1, data.total_requests)) * 100).toFixed(1);
                document.getElementById('l4-success-rate').textContent = successRate + '%';
                document.getElementById('l4-response-time').textContent = data.avg_response_time_ms.toFixed(0) + 'ms';
                document.getElementById('failed-requests').textContent = data.failed_requests;
                document.getElementById('uptime').textContent = Math.floor(data.uptime) + 's';
                
                const utilizationPct = (data.active_connections / maxConnections) * 100;
                document.getElementById('l4-progress').style.width = utilizationPct + '%';
                document.getElementById('l4-progress').textContent = utilizationPct.toFixed(0) + '%';
                
                if (utilizationPct > 90) {
                    document.getElementById('l4-progress').style.background = 'linear-gradient(90deg, #dc2626 0%, #991b1b 100%)';
                    document.getElementById('backend-status').className = 'status-badge status-critical';
                    document.getElementById('backend-status').textContent = 'Critical';
                    showAlert('danger', 'CRITICAL: Connection pool nearly exhausted! (' + data.active_connections + '/' + maxConnections + ')');
                } else if (utilizationPct > 70) {
                    document.getElementById('l4-progress').style.background = 'linear-gradient(90deg, #f59e0b 0%, #d97706 100%)';
                    document.getElementById('backend-status').className = 'status-badge status-warning';
                    document.getElementById('backend-status').textContent = 'Warning';
                    showAlert('warning', 'WARNING: High connection usage (' + data.active_connections + '/' + maxConnections + ')');
                } else {
                    document.getElementById('l4-progress').style.background = 'linear-gradient(90deg, #667eea 0%, #764ba2 100%)';
                    document.getElementById('backend-status').className = 'status-badge status-healthy';
                    document.getElementById('backend-status').textContent = 'Healthy';
                    clearAlerts();
                }
                
                const now = new Date().toLocaleTimeString();
                chartData.labels.push(now);
                chartData.datasets[0].data.push(data.active_connections);
                
                if (chartData.labels.length > 20) {
                    chartData.labels.shift();
                    chartData.datasets[0].data.shift();
                }
                
                chart.update();
                
                document.getElementById('timestamp').textContent = 'Last updated: ' + new Date().toLocaleString();
                
            } catch (error) {
                console.error('Error fetching stats:', error);
            }
        }
        
        function showAlert(type, message) {
            const alertDiv = document.getElementById('alerts');
            const alertClass = type === 'danger' ? 'alert-danger' : 'alert-warning';
            
            if (!alertDiv.querySelector('.alert')) {
                alertDiv.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
            }
        }
        
        function clearAlerts() {
            document.getElementById('alerts').innerHTML = '';
        }
        
        fetchStats();
        setInterval(fetchStats, 2000);
    </script>
</body>
</html>
