<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Cloud Cost Optimizer — Mixed Fleet Dashboard</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=Space+Grotesk:wght@300;400;600;700&display=swap');

  :root {
    --bg:        #f0f6ff;
    --surface:   #ffffff;
    --border:    #dce8f8;
    --blue-900:  #0d47a1;
    --blue-700:  #1565c0;
    --blue-500:  #1976d2;
    --blue-400:  #2196f3;
    --blue-200:  #90caf9;
    --blue-100:  #e3f2fd;
    --spot-bg:   #e8f5e9;
    --spot-fg:   #2e7d32;
    --od-bg:     #fff3e0;
    --od-fg:     #e65100;
    --ri-bg:     #e3f2fd;
    --ri-fg:     #0d47a1;
    --warn-bg:   #fff8e1;
    --warn-fg:   #f57f17;
    --danger-bg: #ffebee;
    --danger-fg: #b71c1c;
    --text:      #1a2840;
    --muted:     #607d99;
    --mono:      'IBM Plex Mono', monospace;
    --sans:      'Space Grotesk', sans-serif;
    --shadow:    0 2px 12px rgba(13,71,161,0.10), 0 1px 4px rgba(13,71,161,0.06);
    --shadow-lg: 0 6px 28px rgba(13,71,161,0.13), 0 2px 8px rgba(13,71,161,0.07);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: var(--sans); background: var(--bg); color: var(--text); min-height: 100vh; }

  header {
    background: linear-gradient(135deg, var(--blue-900) 0%, var(--blue-700) 100%);
    padding: 20px 32px 18px;
    display: flex; align-items: center; justify-content: space-between;
    box-shadow: var(--shadow-lg);
  }
  header .brand { display: flex; align-items: center; gap: 14px; }
  header h1 { color: white; font-size: 1.25rem; font-weight: 700; letter-spacing: -0.02em; }
  header p  { color: var(--blue-200); font-size: 0.78rem; margin-top: 2px; }
  .live-dot {
    width: 10px; height: 10px; border-radius: 50%; background: #69ff90;
    box-shadow: 0 0 8px #69ff90;
    animation: pulse 1.5s ease-in-out infinite;
  }
  @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.6;transform:scale(0.85)} }

  .ticker {
    font-family: var(--mono); font-size: 0.75rem; color: var(--blue-200);
    display: flex; gap: 18px;
  }
  .ticker span { display: flex; align-items: center; gap: 5px; }
  .ticker .val { color: white; font-weight: 600; }

  /* ---- Main layout ---- */
  main { max-width: 1400px; margin: 0 auto; padding: 24px 28px; }

  .kpi-row { display: grid; grid-template-columns: repeat(6, 1fr); gap: 14px; margin-bottom: 22px; }
  .kpi {
    background: var(--surface); border-radius: 12px; padding: 16px 18px;
    box-shadow: var(--shadow); border: 1px solid var(--border);
    display: flex; flex-direction: column; gap: 4px;
    transition: box-shadow .2s;
  }
  .kpi:hover { box-shadow: var(--shadow-lg); }
  .kpi .label { font-size: 0.70rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); font-weight: 600; }
  .kpi .value { font-size: 1.65rem; font-weight: 700; font-family: var(--mono); line-height: 1.1; }
  .kpi .sub   { font-size: 0.72rem; color: var(--muted); margin-top: 2px; }
  .kpi.savings .value { color: var(--spot-fg); }
  .kpi.reserved .value { color: var(--blue-700); }
  .kpi.spot .value { color: var(--spot-fg); }
  .kpi.ondemand .value { color: var(--od-fg); }
  .kpi.cost .value { color: var(--text); }
  .kpi.warn .value { color: #e65100; }

  .panels { display: grid; grid-template-columns: 1fr 420px; gap: 20px; margin-bottom: 20px; }

  /* ---- Instance Grid ---- */
  .card {
    background: var(--surface); border-radius: 14px;
    box-shadow: var(--shadow); border: 1px solid var(--border);
    overflow: hidden;
  }
  .card-header {
    padding: 14px 20px 12px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
  }
  .card-header h2 { font-size: 0.92rem; font-weight: 700; color: var(--blue-900); }
  .card-body { padding: 16px 20px; }

  .instance-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;
  }
  .inst {
    border-radius: 10px; padding: 10px 12px;
    border: 1.5px solid transparent; transition: all .25s;
    font-size: 0.78rem; position: relative; overflow: hidden;
  }
  .inst:hover { transform: translateY(-1px); box-shadow: var(--shadow); }
  .inst.RESERVED  { background: var(--ri-bg);     border-color: var(--blue-200); }
  .inst.ON_DEMAND { background: var(--od-bg);     border-color: #ffcc80; }
  .inst.SPOT      { background: var(--spot-bg);   border-color: #a5d6a7; }
  .inst.INTERRUPT_NOTICE { background: #fff3e0;   border-color: #ffb74d; animation: flash-warn .8s ease-in-out infinite; }
  .inst.DRAINING  { background: var(--danger-bg); border-color: #ef9a9a; animation: flash-danger .6s ease-in-out infinite; }
  .inst.TERMINATED { opacity: 0.35; filter: grayscale(0.8); }

  @keyframes flash-warn   { 0%,100%{border-color:#ffb74d} 50%{border-color:#e65100;box-shadow:0 0 8px rgba(230,81,0,.4)} }
  @keyframes flash-danger { 0%,100%{border-color:#ef9a9a} 50%{border-color:#b71c1c;box-shadow:0 0 8px rgba(183,28,28,.5)} }

  .inst .inst-type { font-weight: 700; font-size: 0.65rem; text-transform: uppercase; letter-spacing: .05em; margin-bottom: 4px; }
  .inst.RESERVED  .inst-type { color: var(--blue-700); }
  .inst.ON_DEMAND .inst-type { color: var(--od-fg); }
  .inst.SPOT      .inst-type { color: var(--spot-fg); }
  .inst.INTERRUPT_NOTICE .inst-type { color: #e65100; }
  .inst.DRAINING  .inst-type { color: var(--danger-fg); }

  .inst .inst-id { font-family: var(--mono); font-size: 0.65rem; color: var(--muted); }
  .inst .inst-family { font-weight: 600; font-size: 0.82rem; color: var(--text); margin: 2px 0; }
  .inst .inst-az { font-size: 0.65rem; color: var(--muted); }
  .inst .inst-cost { font-family: var(--mono); font-size: 0.75rem; font-weight: 600; margin-top: 4px; }
  .inst.RESERVED  .inst-cost { color: var(--blue-700); }
  .inst.ON_DEMAND .inst-cost { color: var(--od-fg); }
  .inst.SPOT      .inst-cost { color: var(--spot-fg); }

  .drain-bar {
    position: absolute; bottom: 0; left: 0; height: 3px;
    background: linear-gradient(90deg, #e65100, #b71c1c);
    transition: width .3s;
  }
  .state-badge {
    font-size: 0.58rem; font-weight: 700; text-transform: uppercase; letter-spacing: .06em;
    padding: 2px 5px; border-radius: 4px; margin-top: 3px; display: inline-block;
  }
  .RUNNING .state-badge           { background: rgba(46,125,50,.12); color: var(--spot-fg); }
  .ON_DEMAND .state-badge         { background: rgba(230,81,0,.10);  color: var(--od-fg); }
  .RESERVED .state-badge          { background: rgba(21,101,192,.10); color: var(--blue-700); }
  .INTERRUPT_NOTICE .state-badge  { background: rgba(230,81,0,.18);  color: #e65100; }
  .DRAINING .state-badge          { background: rgba(183,28,28,.18); color: var(--danger-fg); }
  .TERMINATED .state-badge        { background: rgba(100,100,100,.12); color: var(--muted); }

  /* ---- Right panel ---- */
  .right-panel { display: flex; flex-direction: column; gap: 16px; }

  /* ---- Cost breakdown chart ---- */
  .cost-bar-section { display: flex; flex-direction: column; gap: 8px; }
  .cost-row { display: flex; align-items: center; gap: 10px; }
  .cost-label { width: 90px; font-size: 0.75rem; font-weight: 600; flex-shrink: 0; }
  .cost-bar-track { flex: 1; height: 20px; background: var(--border); border-radius: 6px; overflow: hidden; }
  .cost-bar-fill  { height: 100%; border-radius: 6px; transition: width .5s ease; }
  .cost-amount    { width: 70px; text-align: right; font-family: var(--mono); font-size: 0.75rem; font-weight: 600; flex-shrink: 0; }

  /* ---- Controls ---- */
  .controls-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
  .ctrl { display: flex; flex-direction: column; gap: 5px; align-items: center; text-align: center; }
  .ctrl label { font-size: 0.70rem; font-weight: 700; text-transform: uppercase; letter-spacing: .04em; color: var(--muted); }
  .ctrl .btn-row { display: flex; gap: 5px; }
  .ctrl button {
    width: 30px; height: 30px; border-radius: 7px; border: 1.5px solid var(--border);
    background: var(--surface); font-size: 1rem; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all .15s; color: var(--text);
  }
  .ctrl button:hover { background: var(--blue-100); border-color: var(--blue-400); color: var(--blue-700); }
  .ctrl .count { font-family: var(--mono); font-weight: 700; font-size: 1rem; min-width: 28px; text-align: center; }
  .ctrl.reserved .count { color: var(--blue-700); }
  .ctrl.ondemand .count { color: var(--od-fg); }
  .ctrl.spot     .count { color: var(--spot-fg); }

  .btn-interrupt {
    width: 100%; padding: 10px; border-radius: 10px;
    background: linear-gradient(135deg, #e65100, #bf360c);
    color: white; border: none; cursor: pointer; font-family: var(--sans);
    font-weight: 700; font-size: 0.85rem; letter-spacing: .02em;
    box-shadow: 0 3px 10px rgba(230,81,0,.3); transition: all .15s;
  }
  .btn-interrupt:hover { transform: translateY(-1px); box-shadow: 0 5px 14px rgba(230,81,0,.4); }
  .btn-interrupt:active { transform: translateY(0); }

  /* ---- Event log ---- */
  .log-panel { height: 220px; overflow-y: auto; }
  .log-panel::-webkit-scrollbar { width: 5px; }
  .log-panel::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  .log-entry {
    display: flex; gap: 8px; align-items: flex-start;
    padding: 5px 0; border-bottom: 1px solid #f0f4fa; font-size: 0.75rem;
    animation: fadeIn .3s ease;
  }
  @keyframes fadeIn { from{opacity:0;transform:translateY(-4px)} to{opacity:1;transform:none} }
  .log-entry .log-ts { font-family: var(--mono); color: var(--muted); white-space: nowrap; flex-shrink: 0; }
  .log-entry .log-event {
    font-weight: 700; font-size: 0.65rem; padding: 1px 5px; border-radius: 4px;
    text-transform: uppercase; white-space: nowrap; flex-shrink: 0;
  }
  .log-event.SPOT_INTERRUPT  { background: rgba(230,81,0,.12);  color: #e65100; }
  .log-event.SPOT_DRAIN      { background: rgba(183,28,28,.12); color: var(--danger-fg); }
  .log-event.SPOT_TERMINATE  { background: rgba(100,100,100,.10); color: var(--muted); }
  .log-event.SPOT_REPLACE    { background: rgba(46,125,50,.12);  color: var(--spot-fg); }
  .log-event.BURST_SCALE_UP  { background: rgba(230,81,0,.10);  color: var(--od-fg); }
  .log-event.BURST_SCALE_DOWN{ background: rgba(21,101,192,.10); color: var(--blue-700); }
  .log-event.FLEET_INIT      { background: var(--blue-100);     color: var(--blue-700); }
  .log-event.FLEET_ADJUST    { background: var(--blue-100);     color: var(--blue-700); }
  .log-event.ENGINE_START    { background: rgba(46,125,50,.12);  color: var(--spot-fg); }
  .log-entry .log-msg { color: var(--text); line-height: 1.4; }

  /* ---- Savings comparison bar ---- */
  .savings-section { display: flex; flex-direction: column; gap: 6px; }
  .savings-label { font-size: 0.70rem; text-transform: uppercase; letter-spacing: .05em; color: var(--muted); font-weight: 700; }
  .savings-bar-container { position: relative; height: 36px; background: var(--border); border-radius: 8px; overflow: hidden; }
  .savings-bar-fill {
    height: 100%; border-radius: 8px;
    background: linear-gradient(90deg, var(--blue-700), var(--blue-400));
    transition: width .6s ease; display: flex; align-items: center; padding-left: 10px;
  }
  .savings-bar-text { font-family: var(--mono); font-size: 0.75rem; font-weight: 700; color: white; white-space: nowrap; }

  footer { text-align: center; padding: 18px; font-size: 0.72rem; color: var(--muted); }
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="live-dot"></div>
    <div>
      <h1>Cloud Cost Optimizer</h1>
      <p>Article 201 · Section 8: Production Engineering &amp; Optimization</p>
    </div>
  </div>
  <div class="ticker">
    <span>Fleet: <span class="val" id="hdr-total">—</span></span>
    <span>Effective: <span class="val" id="hdr-cost">—</span>/hr</span>
    <span>Savings: <span class="val" id="hdr-savings">—</span></span>
    <span>Tick: <span class="val" id="hdr-tick">0</span></span>
  </div>
</header>

<main>
  <!-- KPI Row -->
  <div class="kpi-row">
    <div class="kpi savings">
      <div class="label">Overall Savings</div>
      <div class="value" id="kpi-savings">—</div>
      <div class="sub">vs. all On-Demand</div>
    </div>
    <div class="kpi cost">
      <div class="label">Effective Cost</div>
      <div class="value" id="kpi-cost">—</div>
      <div class="sub">$/hr (fleet total)</div>
    </div>
    <div class="kpi reserved">
      <div class="label">Reserved</div>
      <div class="value" id="kpi-reserved">—</div>
      <div class="sub">instances active</div>
    </div>
    <div class="kpi ondemand">
      <div class="label">On-Demand</div>
      <div class="value" id="kpi-ondemand">—</div>
      <div class="sub">burst instances</div>
    </div>
    <div class="kpi spot">
      <div class="label">Spot</div>
      <div class="value" id="kpi-spot">—</div>
      <div class="sub">cost-optimized</div>
    </div>
    <div class="kpi warn">
      <div class="label">Interrupted</div>
      <div class="value" id="kpi-interrupted">—</div>
      <div class="sub">draining now</div>
    </div>
  </div>

  <div class="panels">
    <!-- Instance grid -->
    <div class="card">
      <div class="card-header">
        <h2>Fleet Instances</h2>
        <span style="font-size:.72rem;color:var(--muted)">Real-time state — 3s refresh</span>
      </div>
      <div class="card-body">
        <div class="instance-grid" id="instance-grid"></div>
      </div>
    </div>

    <!-- Right panel -->
    <div class="right-panel">
      <!-- Cost breakdown -->
      <div class="card">
        <div class="card-header"><h2>Hourly Cost Breakdown</h2></div>
        <div class="card-body">
          <div class="savings-section" style="margin-bottom:16px;">
            <div class="savings-label">Savings vs All-On-Demand</div>
            <div class="savings-bar-container">
              <div class="savings-bar-fill" id="savings-bar" style="width:0%">
                <span class="savings-bar-text" id="savings-bar-text">0%</span>
              </div>
            </div>
          </div>
          <div class="cost-bar-section" id="cost-breakdown"></div>
          <div style="margin-top:14px;padding-top:12px;border-top:1px solid var(--border);font-size:.75rem;color:var(--muted)">
            <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
              <span>Daily estimate</span><span style="font-family:var(--mono);font-weight:700;color:var(--text)" id="daily-cost">—</span>
            </div>
            <div style="display:flex;justify-content:space-between;">
              <span>Monthly estimate</span><span style="font-family:var(--mono);font-weight:700;color:var(--text)" id="monthly-cost">—</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Fleet controls -->
      <div class="card">
        <div class="card-header"><h2>Fleet Controls</h2></div>
        <div class="card-body" style="display:flex;flex-direction:column;gap:14px;">
          <div class="controls-grid">
            <div class="ctrl reserved">
              <label>Reserved</label>
              <div class="btn-row">
                <button onclick="adjustFleet('reserved',-1)">−</button>
                <span class="count" id="ctrl-reserved">—</span>
                <button onclick="adjustFleet('reserved',+1)">+</button>
              </div>
            </div>
            <div class="ctrl ondemand">
              <label>On-Demand</label>
              <div class="btn-row">
                <button onclick="adjustFleet('ondemand',-1)">−</button>
                <span class="count" id="ctrl-ondemand">—</span>
                <button onclick="adjustFleet('ondemand',+1)">+</button>
              </div>
            </div>
            <div class="ctrl spot">
              <label>Spot</label>
              <div class="btn-row">
                <button onclick="adjustFleet('spot',-1)">−</button>
                <span class="count" id="ctrl-spot">—</span>
                <button onclick="adjustFleet('spot',+1)">+</button>
              </div>
            </div>
          </div>
          <button class="btn-interrupt" onclick="forceInterrupt()">
            ⚠ Trigger Spot Interruption
          </button>
        </div>
      </div>

      <!-- Event log -->
      <div class="card" style="flex:1">
        <div class="card-header"><h2>Event Log</h2></div>
        <div class="card-body" style="padding:10px 14px;">
          <div class="log-panel" id="event-log"></div>
        </div>
      </div>
    </div>
  </div>
</main>

<footer>System Design Newsletter · Article 201 · Cost Optimization in Cloud Architecture</footer>

<script>
  const WS_URL = `ws://${location.host}`;
  let ws, reconnectTimer;
  let latestMetrics = {};
  let latestByType  = {};

  // ---- WebSocket connection ----
  function connect() {
    ws = new WebSocket(WS_URL);

    ws.onopen    = () => { console.log('[WS] Connected'); };
    ws.onmessage = (e) => { handleMessage(JSON.parse(e.data)); };
    ws.onclose   = () => { reconnectTimer = setTimeout(connect, 2000); };
    ws.onerror   = () => { ws.close(); };
  }

  function handleMessage({ type, data }) {
    if (type === 'STATE_UPDATE') {
      updateDashboard(data);
    } else if (type === 'INTERRUPT') {
      flashAlert(`⚠ INTERRUPT: ${data.id} (${data.family}@${data.az}) — 2-min drain started`);
    } else if (type === 'REPLACE') {
      flashAlert(`✓ REPLACED: ${data.terminated} → ${data.replacement.id} (${data.replacement.family})`, 'green');
    }
  }

  // ---- Dashboard update ----
  function updateDashboard(state) {
    const m = state.metrics;
    latestMetrics = m;
    latestByType  = state.byType;

    // Header ticker
    document.getElementById('hdr-total').textContent   = m.activeCount;
    document.getElementById('hdr-cost').textContent    = `$${m.totalEffectiveHr.toFixed(2)}`;
    document.getElementById('hdr-savings').textContent = `${m.savingsPercent}%`;
    document.getElementById('hdr-tick').textContent    = state.tick;

    // KPIs
    document.getElementById('kpi-savings').textContent    = `${m.savingsPercent}%`;
    document.getElementById('kpi-cost').textContent       = `$${m.totalEffectiveHr.toFixed(2)}`;
    document.getElementById('kpi-reserved').textContent   = m.reservedCount;
    document.getElementById('kpi-ondemand').textContent   = m.onDemandCount;
    document.getElementById('kpi-spot').textContent       = m.spotCount;
    document.getElementById('kpi-interrupted').textContent = m.interruptedCount;

    // Controls
    document.getElementById('ctrl-reserved').textContent = m.reservedCount;
    document.getElementById('ctrl-ondemand').textContent = m.onDemandCount;
    document.getElementById('ctrl-spot').textContent     = m.spotCount;

    // Savings bar
    const sp = Math.min(m.savingsPercent, 90);
    document.getElementById('savings-bar').style.width       = sp + '%';
    document.getElementById('savings-bar-text').textContent  = `${m.savingsPercent}% saved`;

    // Daily/monthly
    document.getElementById('daily-cost').textContent   = `$${m.dailyCost.toFixed(0)}/day`;
    document.getElementById('monthly-cost').textContent = `$${m.monthlyCost.toFixed(0)}/mo`;

    // Cost breakdown bars
    updateCostBreakdown(state);

    // Instance grid
    updateInstanceGrid(state.instances);

    // Event log
    updateEventLog(state.events);
  }

  function updateCostBreakdown(state) {
    const types = [
      { key: 'RESERVED',  label: 'Reserved',  color: 'var(--blue-500)' },
      { key: 'ON_DEMAND', label: 'On-Demand', color: 'var(--od-fg)' },
      { key: 'SPOT',      label: 'Spot',      color: 'var(--spot-fg)' },
    ];
    const maxCost = state.metrics.totalEffectiveHr || 1;
    const el = document.getElementById('cost-breakdown');
    el.innerHTML = '';
    for (const t of types) {
      const instances = (state.byType[t.key] || []).filter(i => i.state !== 'TERMINATED');
      const cost = instances.reduce((s, i) => s + i.effectiveHr, 0);
      const pct  = Math.min((cost / maxCost) * 100, 100);
      el.innerHTML += `
        <div class="cost-row">
          <div class="cost-label" style="color:${t.color}">${t.label}</div>
          <div class="cost-bar-track">
            <div class="cost-bar-fill" style="width:${pct}%;background:${t.color};opacity:.85"></div>
          </div>
          <div class="cost-amount" style="color:${t.color}">$${cost.toFixed(2)}/hr</div>
        </div>`;
    }
  }

  function updateInstanceGrid(instances) {
    const grid = document.getElementById('instance-grid');
    const order = { RESERVED:0, ON_DEMAND:1, SPOT:2, INTERRUPT_NOTICE:3, DRAINING:4, TERMINATED:5 };
    const sorted = [...instances].sort((a,b) => {
      const ao = a.state === 'RUNNING' ? order[a.type] : order[a.state];
      const bo = b.state === 'RUNNING' ? order[b.type] : order[b.state];
      return ao - bo;
    });

    // Update existing or create new
    const existing = {};
    for (const el of grid.querySelectorAll('.inst')) {
      existing[el.dataset.id] = el;
    }
    const seen = new Set();

    for (const inst of sorted) {
      seen.add(inst.id);
      const stateClass = inst.state === 'RUNNING' ? inst.type : inst.state;
      if (existing[inst.id]) {
        const el = existing[inst.id];
        el.className = `inst ${stateClass}`;
        el.querySelector('.inst-type').textContent  = inst.type.replace('_', ' ');
        el.querySelector('.state-badge').textContent = inst.state.replace('_', ' ');
        el.querySelector('.inst-family').textContent = inst.family;
        el.querySelector('.inst-cost').textContent   = `$${inst.effectiveHr.toFixed(4)}/hr`;
        const db = el.querySelector('.drain-bar');
        if (db) db.style.width = inst.drainProgress + '%';
      } else {
        const el = document.createElement('div');
        el.className     = `inst ${stateClass}`;
        el.dataset.id    = inst.id;
        el.innerHTML = `
          <div class="inst-type">${inst.type.replace('_',' ')}</div>
          <div class="inst-id">${inst.id}</div>
          <div class="inst-family">${inst.family}</div>
          <div class="inst-az">${inst.az}</div>
          <div class="inst-cost">$${inst.effectiveHr.toFixed(4)}/hr</div>
          <div class="state-badge">${inst.state.replace('_',' ')}</div>
          <div class="drain-bar" style="width:${inst.drainProgress}%"></div>
        `;
        grid.appendChild(el);
      }
    }

    // Remove terminated instances that are gone from state
    for (const [id, el] of Object.entries(existing)) {
      if (!seen.has(id)) el.remove();
    }
  }

  function updateEventLog(events) {
    const log = document.getElementById('event-log');
    const prevCount = log.querySelectorAll('.log-entry').length;
    if (events.length === prevCount) return;

    log.innerHTML = events.slice().reverse().map(e => `
      <div class="log-entry">
        <span class="log-ts">${e.ts.slice(11,19)}</span>
        <span class="log-event ${e.event}">${e.event.replace(/_/g,' ')}</span>
        <span class="log-msg">${e.message}</span>
      </div>
    `).join('');
  }

  // ---- Flash alert overlay ----
  function flashAlert(msg, color = 'orange') {
    const div = document.createElement('div');
    div.style.cssText = `
      position:fixed; top:80px; right:24px; z-index:9999;
      background:${color === 'green' ? '#e8f5e9' : '#fff3e0'};
      border:1.5px solid ${color === 'green' ? '#a5d6a7' : '#ffcc80'};
      color:${color === 'green' ? '#2e7d32' : '#e65100'};
      padding:10px 16px; border-radius:10px; font-size:.82rem; font-weight:600;
      box-shadow:0 4px 16px rgba(0,0,0,.12); max-width:380px;
      animation: slideIn .3s ease;
    `;
    div.textContent = msg;
    document.body.appendChild(div);
    setTimeout(() => div.remove(), 4000);
  }

  // ---- Fleet controls ----
  async function adjustFleet(type, delta) {
    const body = {
      reservedDelta:  type === 'reserved'  ? delta : 0,
      onDemandDelta:  type === 'ondemand'  ? delta : 0,
      spotDelta:      type === 'spot'      ? delta : 0,
    };
    await fetch('/api/fleet', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  }

  async function forceInterrupt() {
    const res  = await fetch('/api/interrupt', { method: 'POST' });
    const data = await res.json();
    if (!data.ok) flashAlert('No running Spot instances to interrupt', 'green');
  }

  // ---- Boot: fetch initial state so dashboard never shows zeros ----
  fetch('/api/state').then(r => r.json()).then(updateDashboard).catch(() => {});
  connect();
</script>
</body>
</html>
