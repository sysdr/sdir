<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graceful Degradation Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }
        
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .card h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .status-healthy { background: #27ae60; }
        .status-degraded { background: #f39c12; }
        .status-failed { background: #e74c3c; }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        
        .metric-label {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .circuit-state {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
            margin: 0.5rem 0;
        }
        
        .circuit-closed { background: #d5f4e6; color: #27ae60; }
        .circuit-half-open { background: #fef9e7; color: #f39c12; }
        .circuit-open { background: #fadbd8; color: #e74c3c; }
        
        .controls {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .control-group {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .control-group label {
            min-width: 120px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
        
        .test-results {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            max-height: 400px;
            overflow-y: auto;
        }
        
        .log-entry {
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }
        
        .log-success { background: #d5f4e6; color: #27ae60; }
        .log-warning { background: #fef9e7; color: #f39c12; }
        .log-error { background: #fadbd8; color: #e74c3c; }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .connection-status {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            z-index: 1000;
        }
        
        .connected { background: #d5f4e6; color: #27ae60; }
        .disconnected { background: #fadbd8; color: #e74c3c; }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">
        <span class="loading"></span> Connecting...
    </div>
    
    <div class="header">
        <h1>üõ°Ô∏è Graceful Degradation Dashboard</h1>
        <div class="subtitle">Real-time monitoring of service degradation patterns</div>
    </div>
    
    <div class="container">
        <div class="metrics-grid">
            <div class="card">
                <h3>System Health</h3>
                <div class="metric-value" id="systemLoad">0%</div>
                <div class="metric-label">Current Load</div>
                <div style="margin-top: 1rem;">
                    <div class="metric-value" id="requestCount">0</div>
                    <div class="metric-label">Total Requests</div>
                </div>
            </div>
            
            <div class="card">
                <h3>Circuit Breakers</h3>
                <div id="circuitStates">
                    <div class="circuit-state circuit-closed">Product: CLOSED</div>
                    <div class="circuit-state circuit-closed">Payment: CLOSED</div>
                    <div class="circuit-state circuit-closed">Inventory: CLOSED</div>
                </div>
            </div>
            
            <div class="card">
                <h3>Service Status</h3>
                <div id="serviceStates">
                    <div style="margin-bottom: 0.5rem;">
                        <span class="status-indicator status-healthy"></span> Product Service
                    </div>
                    <div style="margin-bottom: 0.5rem;">
                        <span class="status-indicator status-healthy"></span> Payment Service
                    </div>
                    <div style="margin-bottom: 0.5rem;">
                        <span class="status-indicator status-healthy"></span> Inventory Service
                    </div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <h3>üß™ Degradation Testing</h3>
            
            <div class="control-group">
                <label>System Load:</label>
                <button onclick="setSystemLoad(20)">Low (20%)</button>
                <button onclick="setSystemLoad(50)">Medium (50%)</button>
                <button onclick="setSystemLoad(80)">High (80%)</button>
                <button onclick="setSystemLoad(95)">Critical (95%)</button>
            </div>
            
            <div class="control-group">
                <label>Product Service:</label>
                <button onclick="degradeService('product', 0)">Normal</button>
                <button onclick="degradeService('product', 1)">Slow</button>
                <button onclick="degradeService('product', 2)">Errors</button>
                <button onclick="degradeService('product', 3)">Down</button>
            </div>
            
            <div class="control-group">
                <label>Payment Service:</label>
                <button onclick="degradeService('payment', 0)">Normal</button>
                <button onclick="degradeService('payment', 1)">Slow</button>
                <button onclick="degradeService('payment', 2)">Errors</button>
                <button onclick="degradeService('payment', 3)">Down</button>
            </div>
            
            <div class="control-group">
                <label>Inventory Service:</label>
                <button onclick="degradeService('inventory', 0)">Normal</button>
                <button onclick="degradeService('inventory', 1)">Slow</button>
                <button onclick="degradeService('inventory', 2)">Errors</button>
                <button onclick="degradeService('inventory', 3)">Down</button>
            </div>
            
            <div class="control-group">
                <label>Quick Tests:</label>
                <button onclick="testCheckout()">Test Checkout</button>
                <button onclick="loadTest()">Load Test</button>
                <button onclick="resetAll()">Reset All</button>
            </div>
        </div>
        
        <div class="test-results" id="testResults">
            <h3>üìä Test Results & Logs</h3>
            <div id="logContainer">
                <div class="log-entry log-success">System initialized successfully</div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let reconnectTimer = null;
        
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}`);
            
            ws.onopen = () => {
                updateConnectionStatus(true);
                log('WebSocket connected', 'success');
                if (reconnectTimer) {
                    clearInterval(reconnectTimer);
                    reconnectTimer = null;
                }
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                updateDashboard(data);
            };
            
            ws.onclose = () => {
                updateConnectionStatus(false);
                log('WebSocket disconnected', 'error');
                
                if (!reconnectTimer) {
                    reconnectTimer = setInterval(() => {
                        log('Attempting to reconnect...', 'warning');
                        connectWebSocket();
                    }, 5000);
                }
            };
            
            ws.onerror = (error) => {
                log('WebSocket error: ' + error.message, 'error');
            };
        }
        
        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            if (connected) {
                status.className = 'connection-status connected';
                status.innerHTML = 'üü¢ Connected';
            } else {
                status.className = 'connection-status disconnected';
                status.innerHTML = 'üî¥ Disconnected';
            }
        }
        
        function updateDashboard(data) {
            // Update system metrics
            document.getElementById('systemLoad').textContent = `${data.systemLoad}%`;
            document.getElementById('requestCount').textContent = data.requestCount;
            
            // Update circuit breaker states
            const circuitContainer = document.getElementById('circuitStates');
            circuitContainer.innerHTML = '';
            
            Object.entries(data.circuits).forEach(([service, state]) => {
                const div = document.createElement('div');
                div.className = `circuit-state circuit-${state.state.toLowerCase().replace('_', '-')}`;
                div.textContent = `${service.charAt(0).toUpperCase() + service.slice(1)}: ${state.state}`;
                if (state.failureCount > 0) {
                    div.textContent += ` (${state.failureCount} failures)`;
                }
                circuitContainer.appendChild(div);
            });
        }
        
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        async function setSystemLoad(level) {
            try {
                await fetch(`/control/load/${level}`, { method: 'POST' });
                log(`System load set to ${level}%`, 'success');
            } catch (error) {
                log(`Failed to set system load: ${error.message}`, 'error');
            }
        }
        
        async function degradeService(service, level) {
            const levels = ['Normal', 'Slow', 'Error-prone', 'Down'];
            try {
                await fetch(`/control/degrade/${service}/${level}`, { method: 'POST' });
                log(`${service} service degradation set to: ${levels[level]}`, 'warning');
            } catch (error) {
                log(`Failed to degrade ${service}: ${error.message}`, 'error');
            }
        }
        
        async function testCheckout() {
            log('Starting checkout test...', 'info');
            try {
                const response = await fetch('/api/checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        productId: 1,
                        quantity: 1,
                        userId: 'test-user',
                        paymentInfo: { amount: 999, cardType: 'credit' }
                    })
                });
                
                const result = await response.json();
                
                if (result.degradationMode) {
                    log(`Checkout completed with degradation: ${result.fallbacks.join(', ')}`, 'warning');
                } else {
                    log('Checkout completed successfully', 'success');
                }
                
                log(`Order ID: ${result.orderId}`, 'info');
                
            } catch (error) {
                log(`Checkout test failed: ${error.message}`, 'error');
            }
        }
        
        async function loadTest() {
            log('Starting load test (20 concurrent requests)...', 'info');
            
            const promises = [];
            for (let i = 0; i < 20; i++) {
                promises.push(
                    fetch('/api/products').then(r => r.json()).catch(e => ({ error: e.message }))
                );
            }
            
            try {
                const results = await Promise.all(promises);
                const successful = results.filter(r => !r.error).length;
                const fallbacks = results.filter(r => r.source === 'fallback').length;
                
                log(`Load test completed: ${successful}/20 successful, ${fallbacks} fallbacks used`, 
                    successful === 20 ? 'success' : 'warning');
                    
            } catch (error) {
                log(`Load test failed: ${error.message}`, 'error');
            }
        }
        
        async function resetAll() {
            log('Resetting all services...', 'info');
            try {
                await setSystemLoad(0);
                await degradeService('product', 0);
                await degradeService('payment', 0);
                await degradeService('inventory', 0);
                log('All services reset to normal operation', 'success');
            } catch (error) {
                log(`Reset failed: ${error.message}`, 'error');
            }
        }
        
        // Initialize
        connectWebSocket();
        
        // Fetch initial health status
        fetch('/health')
            .then(r => r.json())
            .then(data => {
                log('Initial health check completed', 'success');
                updateDashboard({
                    systemLoad: 0,
                    requestCount: 0,
                    circuits: data.circuits
                });
            })
            .catch(error => log(`Health check failed: ${error.message}`, 'error'));
    </script>
</body>
</html>
